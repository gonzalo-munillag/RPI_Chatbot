version: '3.8'

# Docker Compose for Raspberry Pi
# Multi-container setup: Ollama+FastAPI + WhatsApp Bridge + Piper TTS + Web Portal
# Place this file in /var/www/ollama_chatbot/

services:
  # Service 1: AI Backend (Ollama + FastAPI)
  ollama:
    image: ${DOCKER_USERNAME}/ollama-gemma:latest
    container_name: ollama-gemma
    ports:
      - "8000:8000"              # FastAPI
      - "11434:11434"            # Ollama
    volumes:
      - ollama-data:/root/.ollama      # Ollama models
    restart: unless-stopped
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
      - MODEL_NAME=${MODEL_NAME:-gemma2:2b}     # AI model (from .env, see CUSTOMIZATION_GUIDE.md)
      - SYSTEM_PROMPT=${SYSTEM_PROMPT}          # AI personality (from .env)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    networks:
      - chatbot-network

  # Service 2: WhatsApp Bridge (Node.js + Chromium)
  whatsapp:
    image: ${DOCKER_USERNAME}/whatsapp-bridge:latest
    container_name: whatsapp-bridge
    ports:
      - "127.0.0.1:3000:3000"   # WhatsApp QR (localhost only!)
    volumes:
      - whatsapp-data:/data      # WhatsApp session
    restart: unless-stopped
    environment:
      - OLLAMA_API_URL=http://ollama:8000  # Connect to ollama service
      - AUTHORIZED_NUMBER=${AUTHORIZED_NUMBER}  # Your WhatsApp phone number (from .env file)
      - AUTHORIZED_LID=${AUTHORIZED_LID}  # Your WhatsApp internal ID for groups (from .env file)
      - TTS_API_URL=http://piper-tts:5000  # Connect to TTS service for voice output
    depends_on:
      - ollama
      - piper-tts
    networks:
      - chatbot-network

  # Service 3: Piper TTS (Text-to-Speech)
  # Converts AI responses to speech and plays through speaker
  piper-tts:
    image: ${DOCKER_USERNAME}/piper-tts:latest
    container_name: piper-tts
    ports:
      - "127.0.0.1:5000:5000"   # TTS API (localhost only)
    devices:
      - /dev/snd:/dev/snd       # Access to audio devices (speaker)
    # Note: Voice models are built into the image (see piper-tts/Dockerfile)
    # No volume mount needed - voices are downloaded during docker build
    restart: unless-stopped
    environment:
      - VOICE_MODEL=${VOICE_MODEL:-/app/voices/en_GB-alba-medium.onnx}  # Voice model (from .env)
      - SAMPLE_RATE=22050       # Audio sample rate
      - AUDIO_DEVICE=${AUDIO_DEVICE:-plughw:2,0}  # ALSA audio device for playback
    group_add:
      - audio                   # Add to audio group for speaker access
    networks:
      - chatbot-network

  # Service 4: Whisper STT (Speech-to-Text)
  # Converts spoken audio to text
  whisper-stt:
    image: ${DOCKER_USERNAME}/whisper-stt:latest
    container_name: whisper-stt
    ports:
      - "127.0.0.1:5002:5000"   # STT API (localhost only)
    devices:
      - /dev/snd:/dev/snd       # Access to audio devices (microphone)
    volumes:
      - whisper-models:/app/models  # Persist downloaded Whisper models
    restart: unless-stopped
    environment:
      - WHISPER_MODEL=${WHISPER_MODEL:-tiny}  # Model size: tiny, base, small
      - COMPUTE_TYPE=int8                      # Fastest on CPU
      - AUDIO_DEVICE=${AUDIO_DEVICE_MIC:-plughw:3,0}  # Microphone device
      - SAMPLE_RATE=16000                      # 16kHz optimal for Whisper
    group_add:
      - audio                   # Add to audio group for microphone access
    networks:
      - chatbot-network

  # Service 5: Wake Word Detection (openWakeWord)
  # Hands-free voice activation - say "Hey Jarvis" to activate
  wakeword:
    image: ${DOCKER_USERNAME}/wakeword:latest
    container_name: wakeword
    ports:
      - "127.0.0.1:5003:5000"   # Wake word API (localhost only)
    devices:
      - /dev/snd:/dev/snd       # Access to audio devices (microphone + speaker)
    volumes:
      - wakeword-models:/app/models  # Persist downloaded wake word models
    restart: unless-stopped
    environment:
      - WAKE_WORD_MODEL=${WAKE_WORD_MODEL:-hey_jarvis}  # Wake word to listen for
      - DETECTION_THRESHOLD=0.5                          # Detection sensitivity
      - STT_URL=http://whisper-stt:5000                  # Connect to Whisper STT
      - AI_URL=http://ollama:8000                        # Connect to Ollama AI
      - TTS_URL=http://piper-tts:5000                    # Connect to Piper TTS
      - AUDIO_DEVICE=${AUDIO_DEVICE_MIC:-plughw:3,0}    # Microphone device
      - AUTO_START=${WAKEWORD_AUTO_START:-false}        # Auto-start listening on boot
    depends_on:
      - ollama
      - whisper-stt
      - piper-tts
    group_add:
      - audio                   # Add to audio group for microphone access
    networks:
      - chatbot-network

  # Service 6: Web Portal (Browser-based Chat Interface)
  # ChatGPT-style UI for chatting with the AI from any browser
  web-portal:
    image: ${DOCKER_USERNAME}/web-portal:latest
    container_name: web-portal
    ports:
      - "5054:5054"             # Web Portal (accessible from network)
    restart: unless-stopped
    environment:
      - PORTAL_PASSWORD=${PORTAL_PASSWORD:-prometheus}  # Login password (change in .env!)
      - OLLAMA_URL=http://ollama:8000                   # Connect to Ollama AI
      - TTS_URL=http://piper-tts:5000                   # Connect to Piper TTS for "speak" keyword
    depends_on:
      - ollama
      - piper-tts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5054/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - chatbot-network

  # Service 7: Telegram Bridge (Telegram Bot Interface)
  # Chat with the AI via Telegram - more reliable than WhatsApp
  telegram:
    image: ${DOCKER_USERNAME}/telegram-bridge:latest
    container_name: telegram-bridge
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}         # Bot token from @BotFather (required)
      - AUTHORIZED_USERS=${TELEGRAM_AUTHORIZED_USERS}    # Comma-separated Telegram user IDs
      - AUTHORIZED_GROUPS=${TELEGRAM_AUTHORIZED_GROUPS:-}  # Comma-separated group IDs (optional, leave empty to allow all)
      - OLLAMA_URL=http://ollama:8000                    # Connect to Ollama AI
      - TTS_URL=http://piper-tts:5000                    # Connect to Piper TTS for "speak" keyword
      - MAX_CONTEXT_MESSAGES=10                          # Conversation memory size
    depends_on:
      - ollama
      - piper-tts
    networks:
      - chatbot-network

volumes:
  ollama-data:
    driver: local
  whatsapp-data:
    driver: local
  whisper-models:
    driver: local
  wakeword-models:
    driver: local

networks:
  chatbot-network:
    driver: bridge
